generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  GURU
  SISWA
  ORANG_TUA
}

enum StatusAkun {
  pending
  approved
  rejected
  suspended
}

enum JenisKelamin {
  LAKI_LAKI
  PEREMPUAN
}

enum StatusPresensi {
  HADIR
  IZIN
  SAKIT
  ALFA
}

enum KategoriBuku {
  TAJWID
  TAFSIR
  HADITS
  FIQIH
  AKHLAK
  UMUM
}

enum JenisAktivitas {
  LOGIN
  LOGOUT
  CREATE
  UPDATE
  DELETE
  VIEW
  EXPORT
  IMPORT
}

enum StatusTasmi {
  MENUNGGU
  DISETUJUI
  DITOLAK
  SELESAI
}

enum StatusKelas {
  AKTIF
  NONAKTIF
}

enum LevelTahsin {
  DASAR
  MENENGAH
  LANJUTAN
}

enum StatusPembelajaran {
  LANJUT
  PERBAIKI
}

enum JenisMateri {
  PDF
  YOUTUBE
  VIDEO
}

enum PeranGuru {
  utama
  pendamping
}

model User {
  id               String        @id @default(cuid())
  name             String
  email            String        @unique
  password         String
  role             Role
  image            String?
  emailVerified    DateTime?
  resetToken       String?
  resetTokenExpiry DateTime?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  guru             Guru?
  siswa            Siswa?
  orangTua         OrangTua?
  logActivity      LogActivity[]
  pengumuman       Pengumuman[]
  pengumumanRead   PengumumanRead[] @relation("UserPengumumanRead")
}

model Guru {
  id             String       @id @default(cuid())
  userId         String       @unique
  nip            String?      @unique
  jabatan        String?
  bidangKeahlian String?
  alamat         String?
  noTelepon      String?
  tanggalLahir   DateTime?
  jenisKelamin   JenisKelamin
  tandaTangan    String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  guruKelas      GuruKelas[]
  hafalan        Hafalan[]
  penilaian      Penilaian[]
  presensi       Presensi[]
  bukuDigital    BukuDigital[]
  tahsin         Tahsin[]
  materiTahsin   MateriTahsin[]
  tasmiPengampu   Tasmi[] @relation("GuruPengampu")
  tasmiVerifikasi Tasmi[] @relation("GuruVerifikasi")
  tasmiPenguji    Tasmi[] @relation("GuruPenguji")
  agenda         Agenda[]
}

model Siswa {
  id             String         @id @default(cuid())
  userId         String         @unique
  nisn           String?        @unique
  nis            String         @unique
  kelasId        String?
  alamat         String?
  noTelepon      String?
  tanggalLahir   DateTime?
  jenisKelamin   JenisKelamin
  status         StatusAkun     @default(pending)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  kelas          Kelas?         @relation(fields: [kelasId], references: [id], onDelete: SetNull)
  orangTuaSiswa  OrangTuaSiswa[]
  hafalan        Hafalan[]
  penilaian      Penilaian[]
  presensi       Presensi[]
  targetHafalan  TargetHafalan[]
  tahsin         Tahsin[]
  tasmi          Tasmi[]

  @@index([status])
  @@index([kelasId])
  @@index([nisn])
  @@index([nis])
}

model OrangTua {
  id             String         @id @default(cuid())
  userId         String         @unique
  nik            String         @unique
  pekerjaan      String?
  alamat         String?
  noTelepon      String?
  tanggalLahir   DateTime?
  jenisKelamin   JenisKelamin
  status         StatusAkun     @default(pending)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  orangTuaSiswa  OrangTuaSiswa[]

  @@index([status])
}

model OrangTuaSiswa {
  id         String   @id @default(cuid())
  orangTuaId String
  siswaId    String
  hubungan   String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  orangTua   OrangTua @relation(fields: [orangTuaId], references: [id], onDelete: Cascade)
  siswa      Siswa    @relation(fields: [siswaId], references: [id], onDelete: Cascade)

  @@unique([orangTuaId, siswaId])
  @@index([orangTuaId])
  @@index([siswaId])
}

model TahunAjaran {
  id            String          @id @default(cuid())
  nama          String
  semester      Int?            // 1 atau 2, bisa null jika belum ditentukan
  tanggalMulai  DateTime
  tanggalSelesai DateTime
  isActive      Boolean         @default(false)
  targetHafalan Int?            // Target hafalan tahun ajaran dalam juz
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  kelas         Kelas[]
  targetHafalanData TargetHafalan[]

  @@index([isActive])
}

model Kelas {
  id            String          @id @default(cuid())
  nama          String
  tahunAjaranId String
  kapasitas     Int?
  targetJuz     Int?
  status        StatusKelas     @default(AKTIF)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  tahunAjaran   TahunAjaran     @relation(fields: [tahunAjaranId], references: [id], onDelete: Cascade)
  guruKelas     GuruKelas[]
  siswa         Siswa[]
  targetHafalan TargetHafalan[]
  agenda        Agenda[]

  @@index([status])
  @@index([tahunAjaranId])
}

model GuruKelas {
  id             String     @id @default(cuid())
  guruId         String
  kelasId        String
  peran          PeranGuru  @default(pendamping)
  tanggalMulai   DateTime   @default(now())
  tanggalSelesai DateTime?
  isActive       Boolean    @default(true)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  guru           Guru       @relation(fields: [guruId], references: [id], onDelete: Cascade)
  kelas          Kelas      @relation(fields: [kelasId], references: [id], onDelete: Cascade)

  @@unique([guruId, kelasId])
  @@index([guruId])
  @@index([kelasId])
  @@index([isActive])
  @@index([peran])
}

model TargetHafalan {
  id            String      @id @default(cuid())
  siswaId       String?
  kelasId       String?
  tahunAjaranId String?
  targetJuz     Int
  bulan         Int
  tahun         Int
  targetSurah   String?
  targetAyat    String?
  deadline      DateTime?
  keterangan    String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  siswa         Siswa?      @relation(fields: [siswaId], references: [id], onDelete: Cascade)
  kelas         Kelas?      @relation(fields: [kelasId], references: [id], onDelete: SetNull)
  tahunAjaran   TahunAjaran? @relation(fields: [tahunAjaranId], references: [id], onDelete: SetNull)

  @@index([siswaId])
  @@index([kelasId])
  @@index([deadline])
}

model Hafalan {
  id          String      @id @default(cuid())
  siswaId     String
  guruId      String
  tanggal     DateTime    @default(now())
  juz         Int
  surah       String
  ayatMulai   Int
  ayatSelesai Int
  keterangan  String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  siswa       Siswa       @relation(fields: [siswaId], references: [id], onDelete: Cascade)
  guru        Guru        @relation(fields: [guruId], references: [id], onDelete: Cascade)
  penilaian   Penilaian[]

  @@index([siswaId])
  @@index([tanggal(sort: Desc)])
  @@index([guruId])
}

model Penilaian {
  id         String   @id @default(cuid())
  hafalanId  String
  siswaId    String
  guruId     String
  tajwid     Int
  kelancaran Int
  makhraj    Int
  adab       Int
  nilaiAkhir Float
  catatan    String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  hafalan    Hafalan  @relation(fields: [hafalanId], references: [id], onDelete: Cascade)
  siswa      Siswa    @relation(fields: [siswaId], references: [id], onDelete: Cascade)
  guru       Guru     @relation(fields: [guruId], references: [id], onDelete: Cascade)

  @@index([siswaId])
  @@index([guruId])
  @@index([hafalanId])
}

model Tahsin {
  id                   String              @id @default(cuid())
  siswaId              String
  guruId               String
  tanggal              DateTime            @default(now())
  level                LevelTahsin
  materiHariIni        String
  bacaanDipraktikkan   String
  catatan              String?
  statusPembelajaran   StatusPembelajaran
  // Legacy fields (optional for backward compatibility)
  surah                String?
  ayatAwal             Int?
  ayatAkhir            Int?
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  siswa                Siswa               @relation(fields: [siswaId], references: [id], onDelete: Cascade)
  guru                 Guru                @relation(fields: [guruId], references: [id], onDelete: Cascade)

  @@index([siswaId])
  @@index([guruId])
  @@index([tanggal(sort: Desc)])
  @@index([level])
  @@index([statusPembelajaran])
}

model MateriTahsin {
  id          String       @id @default(cuid())
  guruId      String
  kelasId     String?
  judul       String
  jenisMateri JenisMateri
  fileUrl     String?      // For PDF and Video
  youtubeUrl  String?      // For YouTube
  deskripsi   String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  guru        Guru         @relation(fields: [guruId], references: [id], onDelete: Cascade)

  @@index([guruId])
  @@index([kelasId])
  @@index([jenisMateri])
  @@index([createdAt(sort: Desc)])
}

model Presensi {
  id        String          @id @default(cuid())
  siswaId   String
  guruId    String
  tanggal   DateTime        @default(now())
  status    StatusPresensi
  keterangan String?
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  siswa     Siswa           @relation(fields: [siswaId], references: [id], onDelete: Cascade)
  guru      Guru            @relation(fields: [guruId], references: [id], onDelete: Cascade)

  @@unique([siswaId, tanggal])
  @@index([tanggal(sort: Desc)])
  @@index([status])
}

model Pengumuman {
  id          String              @id @default(cuid())
  userId      String
  judul       String
  isi         String
  tanggalMulai DateTime           @default(now())
  tanggalSelesai DateTime?
  lampiran    String?             // JSON array of file URLs or file metadata
  isPinned    Boolean             @default(false)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  user        User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  pengumumanRead PengumumanRead[]  // Track which users have dismissed this announcement

  @@index([isPinned])
  @@index([tanggalMulai(sort: Desc)])
}

model PengumumanRead {
  id           String      @id @default(cuid())
  pengumumanId String
  userId       String
  closedAt     DateTime    @default(now())  // When user dismissed/closed the announcement
  createdAt    DateTime    @default(now())
  pengumuman   Pengumuman  @relation(fields: [pengumumanId], references: [id], onDelete: Cascade)
  user         User        @relation("UserPengumumanRead", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([pengumumanId, userId])
  @@index([userId])
  @@index([pengumumanId])
  @@index([closedAt(sort: Desc)])
}

model BukuDigital {
  id          String       @id @default(cuid())
  guruId      String
  judul       String
  deskripsi   String?
  kategori    KategoriBuku
  fileUrl     String
  fileName    String
  fileSize    Int
  downloadCount Int        @default(0)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  guru        Guru         @relation(fields: [guruId], references: [id], onDelete: Cascade)

  @@index([guruId])
  @@index([kategori])
  @@index([createdAt(sort: Desc)])
}

model Agenda {
  id           String   @id @default(cuid())
  guruId       String
  kelasId      String?
  judul        String
  deskripsi    String?
  tanggal      DateTime
  waktuMulai   String
  waktuSelesai String?
  status       String   @default("upcoming") // upcoming, berlangsung, selesai
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  guru         Guru     @relation(fields: [guruId], references: [id], onDelete: Cascade)
  kelas        Kelas?   @relation(fields: [kelasId], references: [id], onDelete: SetNull)

  @@index([guruId])
  @@index([kelasId])
  @@index([tanggal(sort: Desc)])
}

model LogActivity {
  id          String         @id @default(cuid())
  userId      String
  role        Role
  aktivitas   JenisAktivitas
  modul       String
  deskripsi   String?
  ipAddress   String?
  device      String?
  createdAt   DateTime       @default(now())
  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt(sort: Desc)])
  @@index([aktivitas])
}

model Motivasi {
  id        String   @id @default(cuid())
  isi       String
  author    String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
}

model AdminSignature {
  id          String   @id @default(cuid())
  type        String   @unique // 'guru' atau 'koordinator'
  signatureData String  // Base64 encoded PNG image
  fileName    String
  fileSize    Int
  imageWidth  Int?     // PNG image width in pixels
  imageHeight Int?     // PNG image height in pixels
  uploadedAt  DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([type])
}

model Tasmi {
  id                String      @id @default(cuid())
  siswaId           String
  jumlahHafalan     Int         // Jumlah hafalan yang sudah dimiliki
  juzYangDitasmi    String      // Juz yang akan di tasmi' kan (contoh: "Juz 1, Juz 2")
  jamTasmi          String?     // Jam yang diajukan untuk tasmi (contoh: "08:00-10:00")
  tanggalTasmi      DateTime?   // Tanggal yang diajukan untuk tasmi
  guruPengampuId    String?     // Guru pengampu dari kelas siswa
  statusPendaftaran StatusTasmi @default(MENUNGGU)
  catatanPenolakan  String?     // Catatan jika ditolak oleh guru
  catatan           String?     // Catatan umum dari siswa
  tanggalDaftar     DateTime    @default(now())
  tanggalUjian      DateTime?   // Tanggal ujian yang dijadwalkan guru
  guruVerifikasiId  String?     // Guru yang menyetujui jadwal
  guruPengujiId     String?     // Guru yang menguji
  // Penilaian Tasmi'
  nilaiKelancaran   Int?        // Nilai kelancaran bacaan (0-100)
  nilaiTajwid       Int?        // Nilai tajwid (0-100)
  nilaiAdab         Int?        // Nilai adab & sikap (0-100)
  nilaiIrama        Int?        // Nilai irama & lagu (0-100)
  nilaiAkhir        Float?      // Nilai akhir (rata-rata otomatis)
  predikat          String?     // Mumtaz, Jayyid Jiddan, Jayyid, Maqbul
  catatanPenguji    String?     // Catatan dari guru penguji
  pdfUrl            String?     // URL PDF hasil penilaian
  publishedAt       DateTime?   // Tanggal hasil dipublish (null = belum publish)
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  siswa             Siswa       @relation(fields: [siswaId], references: [id], onDelete: Cascade)
  guruPengampu      Guru?       @relation("GuruPengampu", fields: [guruPengampuId], references: [id], onDelete: SetNull)
  guruVerifikasi    Guru?       @relation("GuruVerifikasi", fields: [guruVerifikasiId], references: [id], onDelete: SetNull)
  guruPenguji       Guru?       @relation("GuruPenguji", fields: [guruPengujiId], references: [id], onDelete: SetNull)

  @@index([siswaId])
  @@index([statusPendaftaran])
  @@index([tanggalUjian])
  @@index([tanggalTasmi])
  @@index([guruPengampuId])
}
